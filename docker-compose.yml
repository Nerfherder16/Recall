version: "3.9"

services:
  # =============================================================
  # STORAGE LAYER
  # =============================================================

  qdrant:
    image: qdrant/qdrant:latest
    container_name: recall-qdrant
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped

  neo4j:
    image: neo4j:5-community
    container_name: recall-neo4j
    ports:
      - "127.0.0.1:7575:7474"
      - "127.0.0.1:7688:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    environment:
      - NEO4J_AUTH=neo4j/recallmemory
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: recall-postgres
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=recall
      - POSTGRES_PASSWORD=recallmemory
      - POSTGRES_DB=recall
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: recall-redis
    ports:
      - "127.0.0.1:6380:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped

  # =============================================================
  # APPLICATION LAYER
  # =============================================================

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recall-api
    ports:
      - "8200:8000"
    volumes:
      - ./src:/app/src
    environment:
      - RECALL_ENV=development
      - RECALL_QDRANT_HOST=qdrant
      - RECALL_QDRANT_PORT=6333
      - RECALL_NEO4J_URI=bolt://neo4j:7687
      - RECALL_NEO4J_USER=neo4j
      - RECALL_NEO4J_PASSWORD=recallmemory
      - RECALL_POSTGRES_DSN=postgresql+asyncpg://recall:recallmemory@postgres:5432/recall
      - RECALL_REDIS_URL=redis://redis:6379
      - RECALL_OLLAMA_HOST=http://192.168.50.62:11434
      - RECALL_API_KEY=${RECALL_API_KEY:-}
    depends_on:
      - qdrant
      - neo4j
      - postgres
      - redis
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recall-worker
    command: arq src.workers.main.WorkerSettings
    volumes:
      - ./src:/app/src
    environment:
      - RECALL_ENV=development
      - RECALL_QDRANT_HOST=qdrant
      - RECALL_QDRANT_PORT=6333
      - RECALL_NEO4J_URI=bolt://neo4j:7687
      - RECALL_NEO4J_USER=neo4j
      - RECALL_NEO4J_PASSWORD=recallmemory
      - RECALL_POSTGRES_DSN=postgresql+asyncpg://recall:recallmemory@postgres:5432/recall
      - RECALL_REDIS_URL=redis://redis:6379
      - RECALL_OLLAMA_HOST=http://192.168.50.62:11434
      - RECALL_API_KEY=${RECALL_API_KEY:-}
    depends_on:
      - qdrant
      - neo4j
      - postgres
      - redis
    restart: unless-stopped

volumes:
  qdrant_data:
  neo4j_data:
  neo4j_logs:
  postgres_data:
  redis_data:
